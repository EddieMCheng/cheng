<!--http://eddie.cheng.se/V.html -->
<!doctype html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><script type="text/javascript">
/*
	@copyright ©2018
	@author Eddie Cheng

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
var F="Box*.25*w±.5=lin*.25*z*1.414u*.375v±.5*a"
var G=["Vw=-Mx","Vv=-My"],GB=[],GBd=[], GV=[], Gp=[]
var V,I,U,gl,I2d,U2d,img=new Image,images=[],BvAtt,Bdv=[],BcAtt,Bdc=[],dv=[],dc=[],dvr=[],dvg=[],dvb=[],dvx=[],dvy=[],dvz=[],dvX=[],dvY=[],dvZ=[],dva=[],dvi=[]
var Ix=0,Iy=0,Iu=1
var A,all,out,T="New", 	alertUserOnError=true, au=new AudioContext(), sound, Bau, video, cam=0,mic=0,freq=500,pan=0,distort=0
var C="slipxyzrgbuvwodta";	CP=["P",1,0,1,0,0,0,1,1,1,1,0,0,0,0,0,0], CD=["p",1,0,1,0,0,0,1,1,1,0,0,0,0,.5,0,0], CE=["±",0,0,0,0,0,0,0,0,0,0,0,0,0,0.5,0,0]
var B=[],D=[],E=[],L=[],P=[],X=[],Y=[],Z=[],N=0,Np=[],Nl=[],Font="12px",LS=1.5,VS="2.0",VP=1,VF=1,Vv=0,Vw=0,Vo=0,Vx=0,Vy=0,Vz=-1,SS=512,SW=831,SH=412,IS=1,Vr=0,Vg=0,Vb=0,Va=1, Bb=1
var Mx=0,Mx_0=0,Mx_1=0,My=0,My_0=0,My_1=0,touch=0,drag=0,key="",MxB=new Array(5).fill(0),MyB=new Array(5).fill(0),keyB=new Array(10).fill(""),算,抖=1
var Rx=0,Ry=0,Rz=0,Rzr=0,ax=0,ay=0,az=0,rx=0,ry=0,rz=0
var Gfrag,Gvert,vibms,go=1,time=0,dT=0,dA=1,qTime=0,sTime=0,busTime=0, ping=0,timeZone=new Date().getTimezoneOffset()/60;
var GPS=".25"+((Math.round(100*(24+(timeZone)%24)/24)/100)+"").replace("0.","."),LAT=.25,LON=0,ALT,ACC
var WS=[],W="",Wd=[],Wl=0,WP="",Wp=81
var autosave=1
function init(){
	var ATD=decodeURI(window.location.href).replace("?",";").split(";");
	A=ATD[0];if(ATD[1]){readTextUrl(ATD[1].endsWith(".txt")?ATD[1]:ATD[1]+".txt");updateD(ATD)}else updateT(T)
	updateL();Geval();F2DE();DE2B();outG();outF()
	if(gl){
		V.width=SW;V.height=SH
		I.width=SW;I.height=SH
		U.width=SW;U.height=SH
		uidiv.style.width=parseInt(SW)+"px"
		uidiv.style.height=parseInt(SH)+"px"
		datadiv.style.left=(parseInt(SW)+10)+"px"
		updateI()
		gl.viewport(0,0,SW,SH)
		gl.clearColor(Vr,Vg,Vb,Va)		
		gl.lineWidth(LS)
		Gfrag=loadShader(gl,gl.FRAGMENT_SHADER,"varying lowp vec4 vColor; void main(void) {gl_FragColor=vColor;}")
		Gvert=loadShader(gl,gl.VERTEX_SHADER,"attribute vec4 aVxyz; attribute vec4 aVrgb; varying lowp vec4 vColor; void main(void) {gl_Position =vec4(aVxyz); gl_PointSize="+VS+";vColor=aVrgb;}")
		window.requestAnimationFrame(loop)
	}
}
function start(){
//	document.oncontextmenu = document.body.oncontextmenu = function() {return false;}
	let doc=document
	V=doc.getElementById("glcanvas")
	I=doc.getElementById('imgcanvas')
	U=doc.getElementById('uicanvas')
	inF();inG()
	uidiv.ontouchstart=function(ev){setM1(ev.touches[0])}
	uidiv.onmousedown=function(ev){setM1(ev)}
	uidiv.ontouchmove=function(ev){if((gLog.value.includes("Mx")||gLog.value.includes("My"))&&ev.touches.length==1)ev.preventDefault();setM(ev.touches[0])}
	uidiv.onmousemove=function(ev){if(touch)setM(ev)}
	uidiv.ontouchend=function(ev){setM0(ev.touches[0])}
	uidiv.onmouseup=function(ev){setM0(ev)}
	document.onkeydown=function(ev){
		key=ev.code+"_1";setKeyB(ev)
		if(ev.code=="Escape"){inF();inG();go=1}
		else if(ev.code=="Enter"&&ev.ctrlKey){outG();outF();go=1}
		else if(ev.code=="KeyS"&&ev.ctrlKey){ev.preventDefault();urlTFG()}
	}
	document.onkeyup=function(ev){key=ev.code+"_0"}
	window.onerror = function(msg, url, line) {alert('Error: '+msg+'\nLine: '+line);dT=0;return true}
	window.ondeviceorientationabsolute=function(ev) {Rz=ev.alpha/360}
	window.ondeviceorientation=function(ev){Rzr=ev.alpha/360;Ry=ev.beta/360;Rx=ev.gamma/360}
	window.ondevicemotion=function(ev){let eva=ev.accelerationIncludingGravity, drr=ev.rotationRate;ax=eva.x;ay=eva.y;az=eva.z;rx=decimal3(drr.gamma/360);ry=decimal3(drr.beta/360);rz=decimal3(drr.alpha/360)}
	navigator.geolocation.getCurrentPosition(showPosition)
	V.width=SW;V.height=SH
	I.width=SW;I.height=SH
	U.width=SW;U.height=SH

	gl=V.getContext("webgl")
	I2d=I.getContext('2d')
	U2d=U.getContext('2d')

	video = document.querySelector('video')
	
	init()
}
function loop(){
	time= new Date().getTime()
	if(dT!=0&&time-qTime>dT*1000){qTime=time;go=1}

	if(time-sTime>1000){
		sTime=time
		DE2F()
		if(gLog.value.includes("LAT")&&gLog.value.includes("LON")){navigator.geolocation.getCurrentPosition(showPosition)}
		out="D_"+T+"."+HE()+GPS+";G:"+G+";F:"+F+";"+A;
		saveD.value="D_"+T+" ("+kb(out)+")"
		saveF.value="F_"+T+" ("+kb(fLog.value)+")"
		saveG.value="G_"+T+" ("+kb(gLog.value)+")"
		if(WP){
			var dArr=WP.split(" ");Wl=dArr.length
			for(let i=0;i<Wl;i++){
				if(WS[i]&&dArr[i]!=WS[i].ip)WS[i].close()
				if(WS[i])console.log(i+":"+WS[i].readyState)
				if(dArr[i]!=""&&!WS[i]||WS[i].readyState==3){
					WS[i]=new WebSocket('ws://'+dArr[i]+":"+Wp)
					WS[i].idx=i;
					WS[i].ip=dArr[i];
					WS[i].onmessage = function(ev){Wd[this.idx]=ev.data.split(",")}
				}
			}
		}
	}
	if(W&&W.length>0&&(!L["W"]||L["W"]!=W||time-busTime>1000)){
		busTime=time
		L["W"]=W;
		let bus=time+","+T+","+W.split(" ").join(",")+",";
		for(let i=0;i<Wl;i++){
			if(WS[i]&&WS[i].readyState==1)WS[i].send(bus);
		}
	}
	if(go){
		go=0
		DE2B()
		draw()
	}
	ping=new Date().getTime()-time
	window.requestAnimationFrame(loop);
}
function urlTFG(){window.history.pushState(null, "Title", "?D_"+T+";F:"+F+";G:"+G+(Va<1?";Va="+Va:""))}
function updateT(s){
	if(s)T=s.replace("D_","").split(".")[0];document.title="VD - "+T.replace(/_/g," ")
	if(!window.location.href.includes(";"))window.history.pushState(null, "Title", "?D_"+T)
}
function updateD(arr){
	for(var i=0;i<arr.length;i++){
		if(arr[i].includes(":"))setVar(arr[i])
		else if(arr[i].includes("_"))updateT(arr[i])
	}
	inF();
	inG();
}
function loadFiles(files){
	readFile(files[0])
}
function readFile(file){
	let	rdr = new FileReader()
	rdr.onload=function(e){updateD(rdr.result.replace(/\n/g,"").split(";"))}
	rdr.readAsText(file,"UTF-8");
}
function readF(){
	var rdr=new FileReader()
	rdr.onload=function(){fLog.value=rdr.result+",\n\n"+fLog.value;outF()}
	rdr.readAsText(loadF.files[0])
}
function readG(){
	var rdr=new FileReader()
	rdr.onload=function(){gLog.value=rdr.result;outG()}
	rdr.readAsText(loadG.files[0])
}
function readTextUrl(file){
	var raw = new XMLHttpRequest(); raw.open("GET", file, true); 
	raw.onreadystatechange = function (){
		if(file && raw.readyState==4&&(raw.status==200||raw.status==0)){
			if(raw.responseText){updateD(raw.responseText.replace(/\n/g,"").split(";"))}
			else if(file.includes("_"))readTextUrl(file.replace("_","/"))
		}
		else if(raw.status==404 && file.includes("_"))readTextUrl(file.replace("_","/"))
	}
	raw.send(null)
}
function readImgFile(idx){images[idx]=new Image;images[idx].onload=function(){updateI(idx)};images[idx].src=URL.createObjectURL(imgInput.files[0])}
function updateI(idx){
	if(I){
		I2d.scale(IS,IS)
		I2d.clearRect(0,0,I.width,I.height)
			if(idx>=0)img = images[idx]
			if(img){
			I2d.drawImage(img,Ix,Iy,img.width*Iu,img.height*Iu)
		}	
	}
}
function initCam(){
	if(navigator.mediaDevices.getUserMedia) {       
	    navigator.mediaDevices.getUserMedia({video:{width:SW,height:SH,advanced:[{facingMode:"environment"}]}})
	  .then(function(stream){
	    video.srcObject = stream
	    cam=1;if(dT==0)dT=0.04
	  }).catch(function(error){alert(error)})}
}
let audioTrack
let audioTrack1
let offset = 0
function initMic(){
	if(navigator.mediaDevices.getUserMedia) {       
	    navigator.mediaDevices.getUserMedia({audio:true})
	  .then(function(stream){
//		var audioCtx = new AudioContext();
		var source = au.createMediaStreamSource(stream);
		var filter = au.createBiquadFilter()
		filter.type="bandpass"
		filter.frequency.value=880
		filter.Q.value=1.2
//		filter.gain=
		var processor =au.createScriptProcessor(1024);
		processor.onaudioprocess = function(ev){
			var buf=ev.inputBuffer.getChannelData(0);
			var out0=ev.outputBuffer.getChannelData(0);
			var out1=ev.outputBuffer.getChannelData(1);
		//	alert(buf)
			var sample = 0
			let theta
			for(var i=0;i<buf.length;i++){
				if(distort)theta=offset+freq*i*Math.PI/au.sampleRate;
				else theta=1
				out0[i]=buf[i]*Math.sin(theta)
				out1[i]=buf[i]*Math.sin(theta)
				sample=Math.max(sample,out0[i],out1[i])
			}
			offset=theta
			//mic=sample/buf.length
			mic=sample
		}
//		processor.connect(audioCtx.destination)
		source.connect(processor)
//		source.connect(filter)
		var streamDestination = au.createMediaStreamDestination();
		processor.connect(filter)
		filter.connect(streamDestination)
//		filter.connect(au.destination)
	 	audioTrack=streamDestination.stream.getAudioTracks()[0]
//		audioTrack1=streamDestination.stream.getAudioTracks()[0]
	  }).catch(function(error){alert(error)})}
}
let mediaRecorder
let blobs
let url
function record(){
	if(recordbutton.value=="Start Recording"){
//		blobs=[]
		let canvasStream=V.captureStream()
		let canvasTrack=canvasStream.getVideoTracks()[0]		
		let inputStream=new MediaStream()
		inputStream.addTrack(canvasTrack)
		inputStream.addTrack(audioTrack)
//		inputStream.addTrack(audioTrack1)
		mediaRecorder=new MediaRecorder(inputStream)
		mediaRecorder.start();
		mediaRecorder.ondataavailable =function(e){
//		blobs.push(e.data)
		url=window.URL.createObjectURL(e.data,{type:'video/mp4'})
		video.src=url
		}
		mediaRecorder.onstop =function(e){
//			const blob=new Blob(blobs)
//			video.src=window.URL.createObjectURL(blob,{type: 'video/webm'})
		}
		recordbutton.value="Stop Recording"

	}
	else if(recordbutton.value=="Stop Recording"){
		mediaRecorder.stop();
		video.hidden=false
		video.controls=true
		recordbutton.value="Start Recording"
	}	
}
function updateCam(){
	I2d.drawImage(video,0,0)
}
function updateUP(i,font,alpha){
	if(U){
		var id=(D[i][0]).split(".")[0]
		var goName=(L[id+".name"]+"")
		var goFont=L[id+".font"]
		var goAlign=L[id+".align"]
		var typeA=Math.abs(D[i][3])>=2||Math.abs(D[i-D[i][2]][3])>=2
		U2d.textAlign =goAlign?goAlign:"left"
		U2d.fillStyle='rgba('+getByte(i,"r")+','+getByte(i,"g")+','+getByte(i,"b")+','+(typeA*alpha)+')'
		U2d.font=goFont?goFont:font
		U2d.textBaseline = "top"
    	var names=typeA? D[i][0].split("."):" "
		var dots=names.length>1?"...":"";
		U2d.fillText(goName!="undefined"?goName:(names[0]+dots).replace(/_/g," "),(SW/2)+X[i]*SH/2,(SH/2)-Y[i]*(SH/2))
	}
}
function download(type, text, ext) {
	filename= type+"_"+T+"_"+HE()+GPS+"."+ext
	var pom = document.createElement('a'); pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + text.replace(/;/g,";\n" )); pom.setAttribute('download', filename);
	if (document.createEvent) {var event = document.createEvent('MouseEvents'); event.initEvent('click', true, true);pom.dispatchEvent(event);}
	else pom.click();
}
function downloadVideo() {
  var a = document.createElement('a');
  document.body.appendChild(a);
  a.style = 'display: none';
  a.href = url;
  a.download = "R_"+T+"_"+HE()+GPS+".mp4";
  a.click();
  window.URL.revokeObjectURL(url);
}
function addF(s){
	if(!F.includes(s)){F+="+"+s;inF();F2DE()}
}
function setVar(s){
	if(s){
		var sPair=s.split(":")
		var sVal=s.includes(",")?sPair[1].split(",").map(x=>parseFloat(x)?parseFloat(x):x):sPair[1]
		var sArr=sPair[0].split(".")
		if(sArr[0]=="F"){F=sPair[1];inF();F2DE()}
		else if(sArr[0]=="G"){G=sPair[1].split(",");inG();outG();}
		else if(sArr[0]=="T")updateT(sVal)
		else if(L[sArr[0]]!=this[sArr[0]]){
			if(sVal)this[sArr[0]]=sVal
			L[sArr[0]]=this[sArr[0]];
			switch(sArr[0]){
				case "SW":
				case "SH":	V.width=SW;V.height=SH
							I.width=SW;I.height=SH
							U.width=SW;U.height=SH
							uidiv.style.width=parseInt(SW)+"px"
							uidiv.style.height=parseInt(SH)+"px"
							gl.viewport(0,0,SW,SH)
				case "Ix":
				case "Iy":
				case "Iu":
				case "IS":	updateI();break
				case "Vr":
				case "Vg":
				case "Vb":
				case "Va":	gl.clearColor(Vr,Vg,Vb,Va);break
				case "LS":	gl.lineWidth(LS);break
				case "VS":	Gvert=loadShader(gl,gl.VERTEX_SHADER,"attribute vec4 aVxyz; attribute vec4 aVrgb; varying lowp vec4 vColor; void main(void) {gl_Position =vec4(aVxyz); gl_PointSize="+VS+";vColor=aVrgb;}")
							break
				case "F":	
			}
		}
	}
}
function updateL(){
	L=[]
	for(var i=0; i<C.length; i++){L[C[i]]=i}
	L["#N"]=D.length-1
	for(var j=0;j<D.length;j++){
		var par=j-D[j][2]
		var nm=D[j][0].split(".")[0];
		var nNm = nm
		var dp=0
		while((L[nNm] || L[nNm+"_"+dp]) && dp<D.length-1){
			var nmLen=nm.lastIndexOf("_")
			var nmArr=nmLen<0?nm:nm.substring(0,nmLen)
			var nmEndStr= parseInt(nm.substring(nmLen,nm.length)+1)
			nNm=nmEndStr?nmArr+"_"+nmEndStr:nmArr+"_"+dp
			dp++
		}
		L[nNm]=j
		L["#"+j]=j
		D[j][0]=D[j][0].replace(nm,nNm)
	 }
}
function DE2F(){
	F=""
	var C0
	for(var i=0; i<N+1; i++){
		if(D[i][2]==0)C0=CP
		else C0 = CD
		if(D[i][2]==0&&i>0)F+=","
		F+=D[i][0]
		if(D[i][1]>0&&D[i][1]!=CD[1])F+="*"+(D[i][1]+"")
		for(var j=3;j<C.length;j++){
			var CEj=D[i][2]==0?0:CE[j]
			if(j!=2 && (D[i][j]!=C0[j]||E[i][j]!=CEj)&&(D[i][2]!=0||j!=1)){
				if(j>0)F+="*"
				if(D[i][j]!=1)	F+=(round(D[i][j],9)+"")
				if(j>2){		F+=C[j];if(E[i][j]!=CEj)F+="±"+(round(E[i][j],9)+"")}
			}
		}
		if(D[i][2]==0)F+="="
		else if(i<N && D[i+1][2]!=0) F+="+"
	}
}
function F2DE(){
	var commas=F.split(",")
	N=-1
	Np=[],D=[],E=[],Nl=[],Bau=0
	for(var I=0; I<commas.length; I++){
		var adds=commas[I].replace("=","+").split("+")
		var Np_=[],Nl_=[]
		var par=N+1
		for(var i=0; i<adds.length; i++){
			N++
			if(i>0){Np_.push(N);Nl_.push(adds.length-1)}
			D[N]=[], E[N]=[],	D[N][0]="", D[N][1]=i==0?CP[1]:CD[1];	D[N][2]=i
			var multis=adds[i].split("*")
			for(var j=0; j<multis.length; j++){
				var props=multis[j].split("±")
				var prop=props[0]
				var number=Number(prop)
				if(!isNaN(number)){D[N][1]*=number}
				else{
					var propValue=parseFloat(prop)
					var valueStrLen
					if(prop[0]==".")		valueStrLen=propValue.toString().length-1
					else if(propValue==0)	valueStrLen=1
					else if(!propValue){	valueStrLen=0;		propValue=1			}
	 				else{					valueStrLen=propValue.toString().length	}
					var propName=prop.substr(valueStrLen,prop.length-valueStrLen)
					var propIndex
					if(C.includes(propName)){propIndex=L[propName]}
					else{propIndex=1}
					if(propIndex==1&&propName!=C[3]){
						if(D[N][0])D[N][0]+="."
						D[N][0] += propName
						
					}
					if(isNaN(D[N][propIndex]))D[N][propIndex]=1
					D[N][propIndex]*=propValue;		E[N][propIndex]=props[1] ? parseFloat(props[1]):D[N][2]==0?0:CE[propIndex]
				}
			}
			for(var ii=1; ii<C.length; ii++){if(isNaN(D[N][ii])) D[N][ii]=D[N][2]==0?CP[ii]:CD[ii];	if(isNaN(E[N][ii])) E[N][ii]=D[N][2]==0?0:CE[ii]}
		}
		var LEN=D[par][1]
		var NLEN=LEN>0&&LEN<1?1/LEN:LEN
		for(var j=0; j<NLEN;j++){Np=Np.concat(Np_);Nl=Nl.concat(Nl_)}

	}
	updateL();Geval();go=1;
}
function Geval(){
	if(G&&G!=""){
		GV=[],Gp=[],GB=[],GBd=[]
		for(var i=0;i<G.length;i++){
			var Gi=G[i].includes("//")?G[i].substr(0,G[i].indexOf("//")):G[i]
			if(Gi!=""){
				let GiPair=Gi.split("="),Gi0=GiPair[0]?GiPair[0]:null,Gi1=GiPair[1]?GiPair[1]:null
				let idArr=Gi0?Gi0.split("."):"",id0=idArr[0]?idArr[0]:null,id1=idArr[idArr.length-1]
				let Bi=Gi1.indexOf("{"),Bj=Gi1.indexOf("}")
				let Bval=Bi>-1?Gi1.slice(Bi+1,Bj):""
				let vPair=Gi1?Gi1.replace("{"+Bval+"}","").split("±"):"",vl0=vPair[0]?vPair[0]:null,vl1=vPair[1]?vPair[1]:null
				let d=vl0&&question(vl0)?vl0:""
				let fromTo=id0.split("→"),from=fromTo?fromTo[0].split(".")[0]:0,to=fromTo[1]?fromTo[1].split(".")[0]:0
				let pArr=id1.split("")
				if(Gi0.includes(".")&&Gi0.substr(0,5)!="this."){
					if(L[from]&&vl0){
						let isPar=D[L[from]][2]==0
						for(var m=L[from];m<=(L[to]?L[to]:L[from]);m++){
							if((isPar&&D[m][2]==0)||(!isPar&&D[m][2]!=0)){
								let s=D[m][0].split(".")[0],vl0r=vl0.replace(/←/g,s).replace(/⇤/g,s.split("_")[0]);
								if(id1=="name"||id1=="font"||id1=="align"){GV.push("L['"+s+"."+id1+"']="+vdScript(vl0r+d));Gp.push(0);fail=0}
								else if(Gi0.includes(".")&&m){
									var n=L[id1]
									if(Bval!=""){if(!GB[m]){GB[m]=[];GBd[m]=[]}if(!GBd[m][n])GBd[m][n]=[];GB[m][n]=vdScript(Bval)}
									if(vl0&&m){GV.push("D["+m+"]["+n+"]="+vdScript(vl0r+(d!=""?"!D["+m+"]["+n+"]":"")+""));Gp.push(0)}
									if(vl1&&m){GV.push("E["+m+"]["+n+"]="+vdScript(vl1.replace(/←/g,s)+(question(vl1)?"!E["+m+"]["+n+"]":"")+""));Gp.push(0)}
									fail=0
								}
							}
						}
					}
				}
				else{GV.push(Gi0+"="+vdScript(vl0+d));Gp.push(Gi0)} 
			}
		}
	}
}
function DE2B(){
	Bdv=[];Bdc=[];n=0
	if(U)U2d.clearRect(0,0,U.width,U.height);

	var Px,Py,Pz,Pr,Pg,Pb,Pu,Pv,Pw,Pd,Pend, Pi=0, arr=[]
	for(var Ni=Np.length-1; Ni>=0; Ni--){
		var i=Np[Ni]
		var l=Nl[Ni]
		if(D[i][2]==l){
			var LEN=DE(i-l,1)
			var FR=LEN<0
			var FRAC=LEN<1&&LEN>0
			var NLEN=FR?-LEN:FRAC?1/LEN:Math.ceil(LEN)
			if(Pi<=1)Pi=NLEN
			else Pi--
			var S=FR||FRAC?Pi/NLEN:-1
			Px=DEG(i-l,4,S,Pi);	Py=DEG(i-l,5,S,Pi); Pz=DEG(i-l,6,S,Pi)
			Pr=DEG(i-l,7,S,Pi);	Pg=DEG(i-l,8,S,Pi);	Pb=DEG(i-l,9,S,Pi)
			Pu=DEG(i-l,10,S,Pi);Pv=DEG(i-l,11,S,Pi);Pw=DEG(i-l,12,S,Pi)
			Po=DEG(i-l,13,S,Pi);Pd=DEG(i-l,14,S,Pi)
		}

		var len=DE(i,1)
		var type = D[i][16]+D[i-D[i][2]][16]
		var fr=len<0
		var isFrac=(len<1&&len>0)||(type>0&&len==1)
		var jlen=fr?-len:isFrac?1/(len-1e-9):Math.ceil(len)
		var p=DE(i,3)*DE(i-D[i][2],3), pdep=Math.abs(p)>1?1:Math.abs(p)
		var nn=0
		var PArray=D[i][0].split(".")
		let te=E[i][15], tl=te*au.sampleRate, lx=0,ly=0;
		dv[Ni]=[];dc[Ni]=[];dvr[i]=0;dvg[i]=0;dvb[i]=0;dvx[i]=0;dvy[i]=0;dvz[i]=0;dvX[i]=0;dvY[i]=0;dvZ[i]=0;X[i]=0;Y[i]=0;Z[i]=0
		for(var j=0; j<(pdep==0?1:jlen*pdep); j++){
			var s=fr||isFrac?j/jlen:-1
			var d=DEG(i,14,s,j)+Pd
			if(PArray.length>1){
				var ii = d<0?0:d>=1?PArray.length-2:Math.floor((PArray.length-1)*d)
				var i0 = L[PArray[ii]]
				var i1 = L[PArray[ii+1]]
				if(i0 && i1){
					var d2 = (PArray.length-1)*d-ii
					var x=(1-d2)*DE(i0,4,s)+d2*DE(i1,4,s),	y=(1-d2)*DE(i0,5,s)+d2*DE(i1,5,s),	z=(1-d2)*DE(i0,6,s)+d2*DE(i1,6,s)
					var r=(1-d2)*DE(i0,7,s)+d2*DE(i1,7,s),	g=(1-d2)*DE(i0,8,s)+d2*DE(i1,8,s),	b=(1-d2)*DE(i0,9,s)+d2*DE(i1,9,s)
					var u=(1-d2)*DE(i0,10,s)+d2*DE(i1,10,s),	v=(1-d2)*DE(i0,11,s)+d2*DE(i1,11,s),	w=(1-d2)*DE(i0,12,s)+d2*DE(i1,12,s),o=(1-d2)*DE(i0,13,s)+d2*DE(i1,13,s)
				}
			}
			else{
				var x=DEG(i,4,s,j),		y=DEG(i,5,s,j),		z=DEG(i,6,s,j)
				var r=DEG(i,7,s,j),		g=DEG(i,8,s,j),		b=DEG(i,9,s,j)
				var u=DEG(i,10,s,j),	v=DEG(i,11,s,j),	w=DEG(i,12,s,j),	o=DEG(i,13,s,j)
			}
			var	pii = 2*Math.PI,x0,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4,y5,z0,z1,z2,z3,z4,z5
			x0=u*Math.sin((v+Pv)*pii)
			y0=u*Math.cos((v+Pv)*pii)
			z0=u*Math.sin((v+Pv)*pii)*Math.sin(w*pii)+z
			x1=x0*Math.cos(w*pii)
			y1=(y0*Math.cos(-o*pii)+z0*Math.sin(-o*pii))
			z1=(z0*Math.cos(o*pii)+y0*Math.sin(o*pii))
			x2=x*Math.cos(Pv*pii)+y*Math.sin(Pv*pii)+x1
			y2=y*Math.cos(Pv*pii)-x*Math.sin(Pv*pii)+y1
			z2=z1*Math.cos(-Pw*pii)-x2*Math.sin(-Pw*pii)
			x3=(x2*Math.cos(-Pw*pii)+z1*Math.sin(-Pw*pii))*Pu+Px
			y3=(y2*Math.cos(-Po*pii)+z2*Math.sin(-Po*pii))*Pu+Py
			z3=(z2*Math.cos(Po*pii)+y2*Math.sin(Po*pii))*Pu+Pz
			x4=p<0?x3:x3*Math.cos(Vv*pii)+y3*Math.sin(Vv*pii)
			y4=p<0?y3:y3*Math.cos(Vv*pii)-x3*Math.sin(Vv*pii)
			z4=p<0?z3:z3*Math.cos(-Vw*pii)-x4*Math.sin(-Vw*pii)
			x5=p<0?x4+Vx:x4*Math.cos(-Vw*pii)+z3*Math.sin(-Vw*pii)+Vx
			y5=p<0?y4+Vy:y4*Math.cos(-Vo*pii)+z4*Math.sin(-Vo*pii)+Vy
			z5=p<0?z4+Vz:z4*Math.cos(Vo*pii)+y4*Math.sin(Vo*pii)+Vz
			m=j*4
			let angle=p<0?1:Math.acos(-z5/getHyp3(x5,y5,z5)), scale=p>0?angle/getHyp(x5,y5)*VP:z5>1?2*z5*VP:2*VP/(2-z5)
			var xx=x5*scale, yy=y5*scale
			var r1=r*Pr, g1=g*Pg, b1=b*Pb, a1=z5*VF>-1?1:1/(-z5*VF)
			dv[Ni].push(xx*SH/SW,yy,z5*1e-6,1); dc[Ni].push(r1,g1,b1,a1)
			dvr[i]+=r1; dvg[i]+=g1; dvb[i]+=b1
			dvx[i]+=x1; dvy[i]+=y1; dvz[i]+=z1
			dvX[i]+=x3; dvY[i]+=y3; dvZ[i]+=z3
			X[i]+=xx; Y[i]+=yy; Z[i]+=a1
			if(te && !Bau){ 
				sect=tl/10;
				for(let jj=0;jj<sect;jj++){arr[jj]=y1/1000*(jj/sect)*Math.sin(x1*pii*jj/au.sampleRate)}
				let k=0
				for(let jj=sect*(j);jj<sect*(j+1);jj++){let pr=k/sect;arr[jj]=(ly*(1-pr)+y1*pr)/1000*Math.sin((lx*(1-pr)+x1*pr)*pii*jj/au.sampleRate);k++}
				lx=x1;ly=y1
				if(j==Math.ceil(jlen)-1){for(let jj=tl-sect;jj<tl;jj++){arr[jj]=y1/1000*((tl-jj)/sect)*Math.sin(x1*pii*jj/au.sampleRate)}}
			}

		}
		var jlenT=Math.ceil(jlen)
		dvr[i]/=jlenT;dvg[i]/=jlenT;dvb[i]/=jlenT
		dvx[i]/=jlenT;dvy[i]/=jlenT;dvz[i]/=jlenT
		dvX[i]/=jlenT;dvY[i]/=jlenT;dvZ[i]/=jlenT
		X[i]/=jlenT ;Y[i]/=jlenT;Z[i]/=jlenT
		updateUP(i,Font,Z[i])
		if(dv[Ni]){
			dvi[Np.length-Ni-1]=Bdv.length
			Bdv = Bdv.concat(dv[Ni]);Bdc = Bdc.concat(dc[Ni])
		}
		n+=jlen+nn
	} 
	dvi[Np.length]=Bdv.length
	算=Math.round(n)
	let alertsExists=false
	for(var i=0;i<GV.length;i++){
		try{eval(GV[i]);setVar(Gp[i])}
		catch(e){
			alertsExists=true
			if(alertUserOnError)alert("line: "+i+"\nvdscript: "+G[i]+"\njavascript: "+GV[i]+"\n"+e)
		}
	}
	alertUserOnError= !alertsExists
	
	if(!Bau && arr>0){
		var buff = new Float32Array(arr)
		Bau = au.createBuffer(1, buff.length, au.sampleRate)
		Bau.copyToChannel(buff, 0)
      }
}
function draw(a) {
	if(cam)updateCam()
	if(!a)a=1
	var Bv,Bc
	if(Bb>=1){
		gl.blendFunc(gl.SRC_ALPHA,gl.ONE)
		gl.enable(gl.BLEND)
		gl.disable(gl.DEPTH_TEST)
	}
	else{
		gl.clearDepth(-1)
		gl.disable(gl.BLEND)
		gl.enable(gl.DEPTH_TEST)
		gl.depthFunc(gl.GREATER)
	}
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT)
	var Gprog=gl.createProgram()
	gl.attachShader(Gprog, Gvert)
	gl.attachShader(Gprog, Gfrag)
	gl.linkProgram(Gprog);gl.useProgram(Gprog)

	BvAtt=gl.getAttribLocation(Gprog, "aVxyz");	gl.enableVertexAttribArray(BvAtt);	Bv=gl.createBuffer(); 	gl.bindBuffer(gl.ARRAY_BUFFER, Bv);	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(Bdv), gl.DYNAMIC_DRAW)
	BcAtt=gl.getAttribLocation(Gprog, "aVrgb");	gl.enableVertexAttribArray(BcAtt);	Bc=gl.createBuffer();	gl.bindBuffer(gl.ARRAY_BUFFER, Bc);	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(Bdc), gl.DYNAMIC_DRAW)

	gl.bindBuffer(gl.ARRAY_BUFFER, Bv);	gl.vertexAttribPointer(BvAtt, 4, gl.FLOAT, 0, 0, 0)
	gl.bindBuffer(gl.ARRAY_BUFFER, Bc);	gl.vertexAttribPointer(BcAtt, 4, gl.FLOAT, 0, 0, 0)
	for(var Ni=0;Ni<Np.length; Ni++){
		var i=Np[Np.length-Ni-1],type=D[i][16]+D[i-D[i][2]][16]
		gl.drawArrays(type>3?gl.TRIANGLE_FAN:type>2?gl.TRIANGLE_STRIP:type>1?gl.TRIANGLES:type>0.5?gl.LINE_STRIP:type>0?gl.LINES:gl.POINT, (dvi[Ni])/4, ((dvi[Ni+1]-dvi[Ni])/4))
	}
}
function showPosition(position){
	LAT=(90-position.coords.latitude)/360;LON=(360-position.coords.longitude)/360
	ALT = position.coords.altitude; ACC=position.coords.accuracy
	var lat = Math.round(100*LAT)/100+"", lon = Math.round(100*LON)/100+""
	GPS=lat.replace("0.",".")+lon.replace("0.",".")
	
}
function getMx(ev){return 2*decimal4(ev.pageX/SW)-1}
function getMy(ev){return 1-2*decimal4(ev.pageY/SH)}
function setM1(ev){Mx_1=getMx(ev);Mx=Mx_1;My_1=getMy(ev);My=My_1;setMB(ev);touch=1}
function setM0(ev){Mx_0=MxB[0];My_0=MyB[0];touch=0;drag=0;go=1}
function setM(ev){Mx=getMx(ev);My=getMy(ev);setMB(ev);drag=1}
function setMB(ev){MxB.pop();MxB.unshift(getMx(ev));MyB.pop();MyB.unshift(getMy(ev));if(dT==0)go=1}
function setKeyB(ev){keyB.pop();keyB.unshift(ev.code)}
function vdScript(s){return replacer(s,/!/g,":",/></g,"==",/<>/g,"!=",/<</g,"<=",/>>/g,">=",/≡/g,"==",/≠/g,"!=",/≥/g,">=",/≤/g,"<=",/∞/g,"%",/≝/g,"Math.",/([rgbxyzOMXYZ])\((\w+)\)/g,"get$1\('$2'\)",/([BDENS])\((\w+).(\w+)\)/g,"get$1\('$2.$3'\)",/(Space)\((\w+)\)\((\w+)\)/g,"get$1\('$2','$3'\)",/\)\(/g,",")}
function id(s){return document.getElementById(s)}
function inF(){fLog.value=replacer(F,/\+/g,"\n+",/,/g,",\n\n",/=/g,"\n=")}
function outF(){F=replacer(fLog.value,/\n\n/g,"\n",/\n\+/g,"+",/\n=/g,"=",/,\n/g,",",/\n/g,",",/\+-/g,"±",/ /g,"_");F2DE();if(autosave)urlTFG()}
function inG(){gLog.value=G.join(",\n\n")}
function outG(){G=replacer(gLog.value,/\n\n/g,"\n",/,\n/g,",",/\n/g,",",/\+-/g,"±",/%/,"∞",/Math\./g,"≝",/==/g,"≡",/!=/g,"≠",/>=/g,"≥",/<=/g,"≤",/-->/g,"→",/<--/g,"←",/1←/g,"⇤").split(",");Geval();if(autosave)urlTFG();alertUserOnError=true}
function getr(s){let t=dvr[L[s]];return t?t:0}
function getg(s){let t=dvg[L[s]];return t?t:0}
function getb(s){let t=dvb[L[s]];return t?t:0}
function getx(s){let t=dvx[L[s]];return t?t:0}
function gety(s){let t=dvy[L[s]];return t?t:0}
function getz(s){let t=dvz[L[s]];return t?t:0}
function getX(s){let t=dvX[L[s]];return t?t:0}
function getY(s){let t=dvY[L[s]];return t?t:0}
function getZ(s){let t=dvZ[L[s]];return t?t:0}
function getB(s,i){let pair=s.split("."),v=GBd[L[pair[0]]][L[pair[pair.length-1]]][i]; return v?v:0}
function getD(s){let pair=s.split(".");return L[pair[0]]?D[L[pair[0]]][L[pair[pair.length-1]]]:0}
function getE(s){let pair=s.split(".");return L[pair[0]]?E[L[pair[0]]][L[pair[pair.length-1]]]:0}
function getN(s){return L[s]?parseFloat(L[s]):0}
function getS(s){return L[s]?L[s]+"":""}
function getW(i,j){return !Wd[i]?0:Wd[i][j]?Wd[i][j]:0}
function getWS(i){return WS[i]?WS[i]:WebSocket}
function getI(x,y,c){return I2d.getImageData(x,y,1,1).data[c]/255}
function getM(s){return getHyp(X[L[s]]-Mx,Y[L[s]]-My)}
function getO(s){return getHyp3(D[L[s]][4],D[L[s]][5],D[L[s]][6])}
function getSpace(s,t){return getHyp3(dvX[L[s]]-dvX[L[t]],dvY[L[s]]-dvY[L[t]],dvZ[L[s]]-dvZ[L[t]])}
function Ir(x,y){return getI(x,y,0)}
function Ig(x,y){return getI(x,y,1)}
function Ib(x,y){return getI(x,y,2)}
function getVar(s){return s+":"+this[s]}
function loadShader(gl, type, source) {const shader = gl.createShader(type);gl.shaderSource(shader, source);gl.compileShader(shader);return shader;}
function c(v){return v.charCodeAt()}
function kb(s){return s.length/1000+" kb"}
function DEG(p,q,s,i){let v=0,m,n,o,d=DE(p,q,s);if(GB[p]&&GB[p][q]){try{m=i>1?GBd[p][q][i-2]:0,n=i>0?GBd[p][q][i-1]:d;o=GBd[p][q][i];v=eval(GB[p][q]);GBd[p][q][i]=v}catch(e){}}; return d+v}
function DE(m,n,s){return D[m][n]+Err(m,n,s);}
function Err(m,n,s){ if(E[m][n]==0)return 0;else if(s>=0)return E[m][n]*(2*s-1); else return E[m][n]*(Math.random()-Math.random())}
function big(v){return v>61?String.fromCharCode(v+945-62): v>35?String.fromCharCode(v+61):v>9?String.fromCharCode(v+55):v}
function big60(v){return ""+big(Math.floor(v/3600))+big(Math.floor((v%3600)/60))+big(v%60)}
function HE(){let date=new Date();return big60(11900+date.getYear())+big(date.getMonth()+1)+big(date.getDate())+big(date.getHours())+big(date.getMinutes())+big(date.getSeconds())+big(Math.floor(date.getMilliseconds()/40))}
function vib(ms){if(抖)navigator.vibrate(ms)}
function round(v,d){return Math.round(v*Math.pow(10,d))/Math.pow(10,d)}
function decimal3(v){return round(v,3)}
function decimal4(v){return round(v,4)}
function lim(s,s0,s1,t0,t1){return ((s>s1?s1:s<s0?s0:s)-s0)*(t1-t0)/(s1-s0)+t0}
function cos(v){return Math.cos(v*2*PI)}
function sin(v){return Math.sin(v*2*PI)}
function tan(v){return Math.tan(v*2*PI)}
function getHyp(a,b){return Math.sqrt(a*a+b*b)}
function getHyp3(a,b,c){return Math.sqrt(a*a+b*b+c*c)}
function replacer(){let s=arguments[0];for(let i=1;i<arguments.length;i+=2){s=s.replace(arguments[i],arguments[i+1])};return s}
function getByte(idx,s){return Math.floor(D[idx][L[s]]*255)}
function question(s){return s.split("?").length>s.split("!").length}
function playSound(){
	sound = au.createBufferSource()
	sound.buffer = Bau
	sound.connect(au.destination);
	sound.start()
}
</script>
<style>
	html,body{margin:1px;padding:0}
	canvas{position:absolute;left:0px;top:0px;bottom:0px;right:0px}
	#imgcanvas{z-index:-10}
	#datadiv{width:550px}
</style>
</head><body onload="start()">
<div id="uidiv">
	<canvas id="imgcanvas"></canvas>
	<canvas id="glcanvas"></canvas>
	<canvas id="uicanvas"></canvas>
</div></br>
<div id="datadiv">
	<input type="file" onchange="loadFiles(this.files)" multiple=""></input>
	<input id="saveD" type="button" onclick="download('D',out,'txt')"></input>
	<input id="playS" type="button" value="play" onclick="playSound()" hidden></input>
	<input type="button" value="URL" onclick="urlTFG()"></input>
	<input id="saveF" type="button" onclick="download('F','F:'+fLog.value,'txt')"></input>
	<textarea id="fLog" cols="60" rows="10" onchange="outF()" onfocus="inF()"></textarea>
	<input id="saveG" type="button" onclick="download('G','G:'+gLog.value,'txt')"></input>
	<textarea id="gLog" cols="60" rows="10" onchange="outG()" onfocus="inG()"></textarea></p>
	<input value="update" type="button" onclick="inF();inG()"></input>
	<input value="apply" type="button" onclick="outG();outF();go=1"></input>
<br>
 </div>
<div id="imagediv">
	Image:<input id="imgInput" type="file" accept="image/*;capture=camera" onchange="readImgFile(0)"></input>
	<input type="button" onclick="initCam()" value="Camera"></input>
	<input type="button" onclick="initMic()" value="Microphone"></input>
	<input id="recordbutton" type="button" onclick="record()" value="Start Recording"></input>
	<input id="downloadbutton" type="button" onclick="downloadVideo()" value="Download video"></input>
	<input type="button" onclick="uidiv.webkitRequestFullscreen();screen.orientation.lock(screen.orientation.type)" value="fullscreen"></input>
	<video id="video" hidden></video>
</div>
<input type="button" onclick="uidiv.webkitRequestFullscreen();screen.orientation.lock(screen.orientation.type)" value="fullscreen"></input>
</body></html>